let express,jwt,bcrypt,config,validateLoginInput;_275‍.x([["default",()=>_275‍.o]]);_275‍.w("express",[["default",["express"],function(v){express=v}]]);_275‍.w("jsonwebtoken",[["default",["jwt"],function(v){jwt=v}]]);_275‍.w("bcrypt",[["default",["bcrypt"],function(v){bcrypt=v}]]);_275‍.w("../config/config",[["default",["config"],function(v){config=v}]]);_275‍.w("../validation/login",[["default",["validateLoginInput"],function(v){validateLoginInput=v}]]);




const User = require('../models/Users/user_Auth')
const Admin = require('../models/Users/admin_User')
const Voluneteer = require('../models/Users/volunteer_User')
const schPersonnel = require('../models/Users/school_User')

// input validation


const router = new express.Router();

router.post('/admin/signup', adminSignUp);
router.post('/volunteer/signup', volunteerSignUp);
router.post('/schoolPersonnel/signup', schoolPersonnelSignUp);
router.post('/login', login);
//router.get('/verify', verify);
//router.get('/logout', logout);

function adminSignUp (req, res) {
    const { body } = req;
    const { 
        firstName,
        lastName,
        password,
        phoneNumber,
        } = body;
        let {
            email
        } = body;

        if (!firstName) {
            return res.send({
                success: false,
                message: 'Error: First name cannot be blank.'
            });
        }
        if (!lastName) {
        return res.send({
            success: false,
            message: 'Error: Last name cannot be blank.'
        });
        }
        if (!email) {
            return res.send({
                success: false,
                message: 'Error: Email cannot be blank.'
            });
        }
        if (!password) {
            return res.send({
                success: false,
                message: 'Error: Password cannot be blank'
            });
        }
        if (!phoneNumber) {
            return res.send({
                success: false,
                message: 'Error: Phone number cannot be blank'
            });
        }

    email = email.toLowerCase();

    // Steps:
    // 1. Verify email doesn't exist
    // 2. Save to both collections
    User.find({
        email: email
    }, (err, previousUsers) => {
        if (err) {
            return res.send({
                success: false,
                message: 'Error: Server error'
            });
        } else if (previousUsers.length > 0) {
            return res.send({
                success: false,
                message: 'Error: Account already exists.'
            });
        }

        // Save new user to admin collection
        const newAdmin = new Admin();

        newAdmin.firstName = firstName;
        newAdmin.lastName = lastName;
        newAdmin.email = email;
        newAdmin.phoneNumber = phoneNumber;
        
        newAdmin.save((err, admin) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
            return res.send({
                success: true,
                message: 'Signed up'
            });
        });

        //Save new user to user auth collection
        const newUser = new User();

        newUser.email = email;
        newUser.password = newUser.generateHash(password);
        newUser.role = 'Admin'
        
        newUser.save((err, user) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
            return res.send({
                success: true,
                message: 'Signed up'
            });
        });
    });
}

function volunteerSignUp (req, res) {
    const { body } = req;
    const { 
        firstName,
        lastName,
        password,
        phoneNumber,
        pantherID,
        major,
        carAvailable,
        volunteerStatus,
        MDCPS_ID
        } = body;
        let {
            email
        } = body;

        if (!firstName) {
            return res.send({
                success: false,
                message: 'Error: First name cannot be blank.'
            });
        }
        if (!lastName) {
        return res.send({
            success: false,
            message: 'Error: Last name cannot be blank.'
        });
        }
        if (!email) {
            return res.send({
                success: false,
                message: 'Error: Email cannot be blank.'
            });
        }
        if (!password) {
            return res.send({
                success: false,
                message: 'Error: Password cannot be blank'
            });
        }
        if (!phoneNumber) {
            return res.send({
                success: false,
                message: 'Error: Phone number cannot be blank'
            });
        }
        if (!pantherID) {
            return res.send({
                success: false,
                message: 'Error: Panther ID cannot be blank.'
            });
        }
        if (!major) {
        return res.send({
            success: false,
            message: 'Error: Student major cannot be blank.'
        });
        }
        if (!carAvailable) {
            return res.send({
                success: false,
                message: 'Error: Car available cannot be blank.'
            });
        }
        if (!volunteerStatus) {
            return res.send({
                success: false,
                message: 'Error: Password cannot be blank'
            });
        }

    email = email.toLowerCase();

    // Steps:
    // 1. Verify email doesn't exist
    // 2. Save to both collections
    User.find({
        email: email
    }, (err, previousUsers) => {
        if (err) {
            return res.send({
                success: false,
                message: 'Error: Server error'
            });
        } else if (previousUsers.length > 0) {
            return res.send({
                success: false,
                message: 'Error: Account already exists.'
            });
        }

        // Save new user to volunteer collection
        const newVoluneteer = new Voluneteer();

        newVoluneteer.firstName = firstName;
        newVoluneteer.lastName = lastName;
        newVoluneteer.email = email;
        newVoluneteer.phoneNumber = phoneNumber;
        newVoluneteer.pantherID = pantherID;
        newVoluneteer.major = major;
        newVoluneteer.carAvailable = carAvailable;
        newVoluneteer.volunteerStatus = volunteerStatus;

        newVoluneteer.save((err, volunteer) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
            return res.send({
                success: true,
                message: 'Signed up'
            });
        });

        //Save new user to user auth collection
        const newUser = new User();

        newUser.email = email;
        newUser.password = newUser.generateHash(password);
        newUser.role = 'Voluneteer'
        
        newUser.save((err, user) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
        });
    });
}

function schoolPersonnelSignUp (req, res) {
    const { body } = req;
    const { 
        schoolID,
        firstName,
        lastName,
        password,
        title,
        phoneNumber,
        } = body;
        let {
            email
        } = body;

        if (!schoolID) {
            return res.send({
                success: false,
                message: 'Error: School ID cannot be blank.'
            });
        }
        if (!firstName) {
        return res.send({
            success: false,
            message: 'Error: First name cannot be blank.'
        });
        }
        if (!lastName) {
            return res.send({
                success: false,
                message: 'Error: Last name cannot be blank.'
            });
        }
        if (!password) {
            return res.send({
                success: false,
                message: 'Error: Password cannot be blank'
            });
        }
        if (!title) {
            return res.send({
                success: false,
                message: 'Error: Title/Position cannot be blank'
            });
        }
        if (!phoneNumber) {
            return res.send({
                success: false,
                message: 'Error: Phone number cannot be blank'
            });
        }

    email = email.toLowerCase();

    // Steps:
    // 1. Verify email doesn't exist
    // 2. Save to both collections
    User.find({
        email: email
    }, (err, previousUsers) => {
        if (err) {
            return res.send({
                success: false,
                message: 'Error: Server error'
            });
        } else if (previousUsers.length > 0) {
            return res.send({
                success: false,
                message: 'Error: Account already exists.'
            });
        }

        // Save new user to admin collection
        const newSchPersonnel = new schPersonnel();

        newSchPersonnel.firstName = firstName;
        newSchPersonnel.lastName = lastName;
        newSchPersonnel.email = email;
        newSchPersonnel.phoneNumber = phoneNumber;
        newSchPersonnel.schoolID = schoolID;
        newSchPersonnel.title = title;
        
        newSchPersonnel.save((err, schPersonnel) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
            return res.send({
                success: true,
                message: 'Signed up'
            });
        });

        //Save new user to user auth collection
        const newUser = new User();

        newUser.email = email;
        newUser.password = newUser.generateHash(password);
        newUser.role = 'School Personnel'
        
        newUser.save((err, user) => {
            if (err) {
                return res.send({
                    success: false,
                    message: 'Error: Server error'
                });
            }
            return res.send({
                success: true,
                message: 'Signed up'
            });
        });
    });
}

function login (req, res) {

    // form validation
    const { errors, isValid } = validateLoginInput(req.body);

    // check validation
	if (!isValid) {
		return res.status(400).json(errors);
	}

    const email = req.body.email;
    const password = req.body.password;

    // find user by email
	User.findOne({ email }).then(user => {
		if (!user) {
			return res.status(404).json({ email: 'Email not found' });
		}
		else {
			// check password
			bcrypt.compare(password, user.password).then(isMatch => {
				if (isMatch) {
					// user matched
					// create JWT Payload
					const payload = {
						id: user.id
					};
					// sign token
					jwt.sign(
						payload,
						config.secretOrKey,
						{
							expiresIn: 86400 // 1 day in seconds
						},
						(err, token) => {
							res.json({
								success: true,
								token: 'Bearer ' + token
							});
						}
					);
				}
				else {
					return res
						.status(400)
						.json({ password: 'Password incorrect' });
				}
			});
		}
	});
}

function verify (req, res) {
    const { query } = req;
    const { token } = query;

    UserSession.find({
        _id: token,
        isDeleted: false
    }, (err, sessions) => {
        if (err) {
            return res.send({
                success: false,
                message: 'Error: Server error'
            });
        }

        if (sessions.length != 1) {
            return res.send({
                success: false,
                message: 'Error: Invalid'
            });
        } else {
            return res.send({
                success: true,
                message: 'Good'
            });
        }
    });
}


function logout (req, res) {
    const { query } = req;
    //const { token } = query;

    _275‍.g.console.log(req.body)

    UserSession.findOneAndUpdate({
        //_id: token,
        isDeleted: false
    }, {
        $set:{
            isDeleted: true,
        }
    }, null, (err, sessions) => {
        if (err) {
            return res.send({
                success: false,
                message: 'Error: Server error'
            });
        }

        return res.send({
            success: true,
            message: 'Good'
        });
    });
}

_275‍.d({router});